<!DOCTYPE HTML>
<html>
    <head>
        <meta charset = "utf-8">
        <meta name = "viewport" content = "width=device-width, initial-scale = 1" />
        <script src = "https://use.fontawesome.com/d1341f9b7a.js"></script>
        <link rel = "stylesheet" href = "style.css">
        <title>Musical Note Recognition</title>
    </head>
<body>
    <div class = box>
        <h1>Musical Note Recognition</h1>
        <p>To determine the chords from a mp3 file, click the upload button below to upload your file. Once you submit file, you will find a table with the timestamps and chords</p>
        <form method="post">
            <input type="File" id="upload" accept=".mp3" name="filename"/>
            <input type="submit" name="submit"/>
        </form>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
        <script src="upload.js"></script>
        <p>To determine the chords from a live recording, click the record button below to record the song in the surrounding. Once you submit the recording, you will find a table with the timestamps and chords</p>
        <p><button id="btnStart">START RECORDING</button>
            <!-- <script>
                function addCode() { 
                    document.getElementById("add_to_me").innerHTML +=  "<h3>Recording...</h3>";
                }
            </script> -->
            <button id="btnStop">STOP RECORDING</button></p> 
            <!-- <script>
                function addCode() { 
                    document.getElementById("add_to_me").innerHTML +=  "<h3>Finished Recording</h3>";
                }  -->
            </script>
        </br>
            
            <audio id="audio" controls></audio>
         </br>
            <p><input type="submit" name="submit"/></p>
            <script>
        
                let constraintObj = { 
                    audio: true, 
                    video: false
                }; 
                // width: 1280, height: 720  -- preference only
                // facingMode: {exact: "user"}
                // facingMode: "environment"
                
                //handle older browsers that might implement getUserMedia in some way
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {};
                    navigator.mediaDevices.getUserMedia = function(constraintObj) {
                        let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                        if (!getUserMedia) {
                            return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                        }
                        return new Promise(function(resolve, reject) {
                            getUserMedia.call(navigator, constraintObj, resolve, reject);
                        });
                    }
                }else{
                    navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        devices.forEach(device=>{
                            console.log(device.kind.toUpperCase(), device.label);
                            //, device.deviceId
                        })
                    })
                    .catch(err=>{
                        console.log(err.name, err.message);
                    })
                }
        
                navigator.mediaDevices.getUserMedia(constraintObj)
                .then(function(mediaStreamObj) {
                    //connect the media stream to the first video element
                    // let audio = document.querySelector('audio');
                    // if ("srcObject" in audio) {
                    //     audio.srcObject = mediaStreamObj;
                    // } else {
                    //     //old version
                    //     video.src = window.URL.createObjectURL(mediaStreamObj);
                    // }
                    
                    // video.onloadedmetadata = function(ev) {
                    //     //show in the video element what is being captured by the webcam
                    //     video.play();
                    // };
                    
                    //add listeners for saving video/audio
                    let start = document.getElementById('btnStart');
                    let stop = document.getElementById('btnStop');
                    let vidSave = document.getElementById('audio');
                    let mediaRecorder = new MediaRecorder(mediaStreamObj);
                    let chunks = [];
                    
                    start.addEventListener('click', (ev)=>{
                        mediaRecorder.start();
                        console.log(mediaRecorder.state);
                    })
                    stop.addEventListener('click', (ev)=>{
                        mediaRecorder.stop();
                        console.log(mediaRecorder.state);
                    });
                    mediaRecorder.ondataavailable = function(ev) {
                        chunks.push(ev.data);
                    }
                    mediaRecorder.onstop = (ev)=>{
                        let blob = new Blob(chunks, { 'type' : 'audio/mp3;' });
                        chunks = [];
                        let videoURL = window.URL.createObjectURL(blob);
                        vidSave.src = videoURL;
                    }
                })
                .catch(function(err) { 
                    console.log(err.name, err.message); 
                }); 
                /*********************************
                getUserMedia returns a Promise
                resolve - returns a MediaStream Object
                reject returns one of the following errors
                AbortError - generic unknown cause
                NotAllowedError (SecurityError) - user rejected permissions
                NotFoundError - missing media track
                NotReadableError - user permissions given but hardware/OS error
                OverconstrainedError - constraint video settings preventing
                TypeError - audio: false, video: false
                *********************************/
            </script>
            
    </div>
</body>
</html>
